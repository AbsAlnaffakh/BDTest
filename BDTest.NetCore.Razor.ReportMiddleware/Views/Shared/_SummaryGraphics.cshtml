@using BDTest
@using BDTest.NetCore.Razor.ReportMiddleware.Extensions
@using BDTest.Test
@using Microsoft.AspNetCore.Http.Extensions
@model BDTest.NetCore.Razor.ReportMiddleware.Models.ViewModels.SummaryViewModel
@{
    var total = Model.Scenarios.Count;
    var passed = Model.Scenarios.Count(scenario => scenario.Status == Status.Passed);
    var passedPercent = GetPercentage(passed, total);
    var failed = Model.Scenarios.Count(scenario => scenario.Status == Status.Failed);
    var failedPercent = GetPercentage(failed, total);
    var skipped = Model.Scenarios.Count(scenario => scenario.Status == Status.Skipped);
    var notImplemented = Model.Scenarios.Count(scenario => scenario.Status == Status.NotImplemented);
    var inconclusive = Model.Scenarios.Count(scenario => scenario.Status == Status.Inconclusive);
    var otherPercent = GetPercentage(skipped + notImplemented + inconclusive, total);
    var testTimer = BDTestUtil.GetTestTimer(Model.Scenarios, Model.TotalReportData);

    var currentUri = new Uri(Context.Request.GetEncodedUrl());
    _isSummaryPage = currentUri.AbsolutePath.Contains("/summary");

    var pointerClassIfSummaryPage = _isSummaryPage ? "pointer" : string.Empty;
    var currentId = currentUri.ToString().Split("report/")[1].Split("/")[0];
    var allScenariosUri = currentUri.WithPath($"bdtest/report/{currentId}/all-scenarios");
}

@functions
{
    private double GetPercentage(double scenarioCount, double total)
    {
        return (scenarioCount / total) * 100;
    }
}

<div class="progress mb-5">
      <div class="progress-bar bg-success progress-bar-striped progress-bar-animated" role="progressbar" style="width: @passedPercent%" aria-valuenow="@passedPercent" aria-valuemin="0" aria-valuemax="100"></div>
      <div class="progress-bar bg-danger progress-bar-striped progress-bar-animated" role="progressbar" style="width: @failedPercent%" aria-valuenow="@failedPercent" aria-valuemin="0" aria-valuemax="100"></div>
      <div class="progress-bar bg-warning progress-bar-striped progress-bar-animated" role="progressbar" style="width: @otherPercent%" aria-valuenow="@otherPercent" aria-valuemin="0" aria-valuemax="100"></div>
    </div>

<div id="summary-boxes">

    <div class="card text-center text-white bg-primary mb-3 mx-auto @pointerClassIfSummaryPage" style="max-width: 18rem;" onclick="@MakeUrl(allScenariosUri)">
        <div class="card-header">Tests Run</div>
        <div class="card-body">
            <h5 class="card-title">@total</h5>
        </div>
    </div>

    <div class="container">
        <div class="card-columns d-flex justify-content-center">
            <div class="card text-center text-dark bg-light mb-3 mx-auto" style="max-width: 18rem;">
                <div class="card-header">Started at</div>
                <div class="card-body">
                    <h5 class="card-title">@testTimer.TestsStartedAt.ToStringForReport()</h5>
                </div>
            </div>

            <div class="card text-center text-dark bg-light mb-3 mx-auto" style="max-width: 18rem;">
                <div class="card-header">Time Taken</div>
                <div class="card-body">
                    <h5 class="card-title">@testTimer.ElapsedTime.ToPrettyFormat()</h5>
                </div>
            </div>
    
            <div class="card text-center text-dark bg-light mb-3 mx-auto" style="max-width: 18rem;">
                <div class="card-header">Finished at</div>
                <div class="card-body">
                    <h5 class="card-title">@testTimer.TestsFinishedAt.ToStringForReport()</h5>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="card-columns d-flex justify-content-center">
            <div class="card text-center text-white bg-success mb-3 mx-auto @pointerClassIfSummaryPage" style="min-width: 12rem; max-width: 18rem;" onclick="@MakeUrl(allScenariosUri.WithQueryParameter("filterByStatus", Status.Passed.ToString()))">
                <div class="card-header">Passed</div>
                <div class="card-body">
                    <h5 class="card-title">@passed</h5>
                </div>
            </div>

            <div class="card text-center text-white bg-warning mb-3 mx-auto @pointerClassIfSummaryPage" style="min-width: 12rem; max-width: 18rem;" onclick="@MakeUrl(allScenariosUri.WithQueryParameter("filterByStatus", Status.Skipped.ToString()))">
                <div class="card-header">Skipped</div>
                <div class="card-body">
                    <h5 class="card-title">@skipped</h5>
                </div>
            </div>
            
            <div class="card text-center text-white bg-warning mb-3 mx-auto @pointerClassIfSummaryPage" style="min-width: 12rem; max-width: 18rem;" onclick="@MakeUrl(allScenariosUri.WithQueryParameter("filterByStatus", Status.NotImplemented.ToString()))">
                <div class="card-header">Not Implemented</div>
                <div class="card-body">
                    <h5 class="card-title">@notImplemented</h5>
                </div>
            </div>
            
            <div class="card text-center text-white bg-warning mb-3 mx-auto @pointerClassIfSummaryPage" style="min-width: 12rem; max-width: 18rem;" onclick="@MakeUrl(allScenariosUri.WithQueryParameter("filterByStatus", Status.Inconclusive.ToString()))">
                <div class="card-header">Inconclusive</div>
                <div class="card-body">
                    <h5 class="card-title">@inconclusive</h5>
                </div>
            </div>

            <div class="card text-center text-white bg-danger mb-3 mx-auto @pointerClassIfSummaryPage" style="min-width: 12rem; max-width: 18rem;" onclick="@MakeUrl(allScenariosUri.WithQueryParameter("filterByStatus", Status.Failed.ToString()))">
                <div class="card-header">Failed</div>
                <div class="card-body">
                    <h5 class="card-title">@failed</h5>
                </div>
            </div>
        </div>
    </div>
</div>

@functions
{
    private string MakeUrl(Uri url)
    {
        return _isSummaryPage ? $"window.location = '{url}'" : "return false;";
    }

    private bool _isSummaryPage;
}
